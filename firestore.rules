rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true ||
        'app admin' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userRoles
      );
    }

    function isFullAppAdmin() {
      return isAdmin() && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.appAdminLevel != 'limited'
      );
    }

    // Users can read/write their own user document
    // Admins can read/write any user document
    // Public read access for shortname lookup (for booking pages) - handled via Cloud Function
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }
    
    // Job events are read-only for users, writable by service accounts
    match /job_events/{eventId} {
      allow read: if request.auth != null;
      allow write: if false; // Only EC2 scrapers can write (via service account)
    }
    
    // Delivery tracking is read-only for users
    match /job_events/{eventId}/deliveries/{deliveryId} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Posts collection
    match /posts/{postId} {
      // Users can read approved posts or their own posts
      // Admins can read all posts
      allow read: if request.auth != null && (
        resource.data.approvalStatus == 'approved' ||
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Users can create posts
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Users can update/delete their own posts
      // Admins can update any post (for approval actions)
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Comments subcollection
      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
        
        // Comment votes/views subcollections
        match /upvotes/{userId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
        match /downvotes/{userId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
        match /views/{userId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
      
      // Post votes/views subcollections
      match /upvotes/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /downvotes/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /views/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Post flags subcollection (users can flag/unflag posts)
      match /flags/{userId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Message logs (for debugging)
    match /messageLogs/{logId} {
      allow read, write: if false; // Internal only
    }
    
    // Blocked IPs collection (admin only)
    match /blocked_ips/{blockId} {
      allow read, write: if isAdmin();
    }
    
    // Business card orders collection
    match /business_card_orders/{orderId} {
      // Users can read their own orders
      // Admins can read all orders
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      // Users can create their own orders
      allow create: if request.auth != null && 
                     request.resource.data.userId == request.auth.uid;
      // Only admins can update orders (for fulfillment status, refunds, etc.)
      allow update: if isAdmin();
    }

    // Site improvements queue (admin tool)
    match /site_improvements/{requestId} {
      // App admins (limited/full) can read all requests (open + archived)
      allow read: if isAdmin();

      // App admins can create requests (plain text, max 5000 chars)
      allow create: if isAdmin()
        && request.resource.data.status == 'open'
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.text.size() <= 5000
        && (!('imageUrls' in request.resource.data) || request.resource.data.imageUrls is list);

      // Only full app admins can archive/update requests (copy workflow)
      allow update, delete: if isFullAppAdmin();
    }
    
    // Email queue collection (Cloud Functions only)
    match /email_queue/{emailId} {
      allow read, write: if false; // Internal only, accessed via Cloud Functions
    }
  }
}

